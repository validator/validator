name: Check that PR includes test changes

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  require-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for “no-tests-needed” label
        id: label-check
        run: |
          LABELS=$(jq -r '[.pull_request.labels[].name] | join(" ")' <<< '${{ toJson(github.event) }}')
          echo "Labels on PR: $LABELS"
          if echo "$LABELS" | grep -q '\bno-tests-needed\b'; then
            echo "has_label=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_label=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get list of changed files
        id: changes
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          git fetch origin "$BASE_SHA" --depth=1
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA"...HEAD)
          {
            echo "files<<EOF"
            echo "$CHANGED_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Fail if checker Java code or RNG schema changed but no tests changed
        if: steps.label-check.outputs.has_labels != 'true'
        run: |
          CODE_CHANGED=$(echo "${{ steps.changes.outputs.files }}" | grep -E '^(schema/|src/nu/validator/checker/)' || true)
          TESTS_CHANGED=$(echo "${{ steps.changes.outputs.files }}" | grep -E '^tests/' || true)
          if [ -n "$CODE_CHANGED" ] && [ -z "$TESTS_CHANGED" ]; then
            echo "::error::This PR changes files in schema/ or src/nu/validator/checker/ but not in tests/."
            echo '::error::If this is intentional, add the label “no-tests-needed” to override this check.'
            exit 1
          fi

      - name: Skip check (label override)
        if: steps.label-check.outputs.has_label == 'true'
        run: echo '“no-tests-needed” label found — skipping test-requirement check.'
