name: Build

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  prep:
    name: Prepare the build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
  build:
    name: Build on ${{ matrix.os }} with Java ${{ matrix.java }}
    needs: prep
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java: [25, 21, 17, 11.0.23]
        exclude:
          - os: macos-latest
            java: 11.0.23
          - os: windows-latest
            java: 11.0.23
    env:
      IS_MAIN_RELEASE_BUILDER: ${{ github.event_name == 'push' &&
                              github.ref == 'refs/heads/main' &&
                              matrix.os == 'ubuntu-latest' &&
                              matrix.java == 25 }}
      IS_ANY_RELEASE_BUILDER: ${{ github.event_name == 'push' &&
                              github.ref == 'refs/heads/main' &&
                              matrix.java == 25 }}
    steps:
      - uses: actions/checkout@v5
      - name: Set up Java JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: ${{ matrix.java }}
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Install dependencies
        run: python checker.py dldeps
      - name: Build
        shell: bash
        run: |
          version="$(date +"%y.%m.%d") ($(git rev-parse --short ${{ github.sha }}))"
          python checker.py --version="$version" build
          python checker.py --version="$version" jar
          python checker.py --version="$version" image
          python checker.py --version="$version" war
      - name: Test
        shell: bash
        env:
          TOMCAT_VERSION: 8.5.29
        run: |
          java -jar build/dist/vnu.jar site/nu-about.html
          jar xf build/dist/vnu.jar && javap -verbose nu/validator/client/SimpleCommandLineValidator.class | grep "major version: 55"
          curl -O https://archive.apache.org/dist/tomcat/tomcat-8/v${{ env.TOMCAT_VERSION }}/bin/apache-tomcat-${{ env.TOMCAT_VERSION }}.zip
          unzip apache-tomcat-${{ env.TOMCAT_VERSION }}.zip
          chmod a+x apache-tomcat-${{ env.TOMCAT_VERSION }}/bin/*.sh
          jar xf build/dist-war/vnu.war && javap -verbose WEB-INF/classes/nu/validator/servlet/VerifierServlet.class | grep "major version: 52"
          apache-tomcat-${{ env.TOMCAT_VERSION }}/bin/catalina.sh start
          cp build/dist-war/vnu.war apache-tomcat-${{ env.TOMCAT_VERSION }}/webapps/
          sleep 15; tail apache-tomcat-${{ env.TOMCAT_VERSION }}/logs/catalina.out || true
          curl -sS 'http://localhost:8080/vnu/?out=gnu&doc=data:text/html;charset=utf-8,%3C%21doctype%20html%3E%3Cmeta%20charset%3Dutf-8%3E%3Ctitle%3ETest%3C%2Ftitle%3E' > RESULTS
          test -z "$(if [ -t RESULTS ]; then cat RESULTS | grep -v '^$'; fi)"
          # shellcheck disable=SC2181
          if [ $? != 0 ]; then cat RESULTS; fi
          python ./checker.py self-test
          python ./checker.py test
      - name: Import GPG signing key
        if: ${{ env.IS_ANY_RELEASE_BUILDER == 'true' }}
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_SIGNING_KEY }}
          passphrase: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      - name: Sign https://github.com/validator/validator/releases files
        if: ${{ env.IS_ANY_RELEASE_BUILDER == 'true' }}
        shell: bash
        run: |
          python ./checker.py sign
      - name: Release new binary runtime image
        if: ${{ env.IS_ANY_RELEASE_BUILDER == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          allowUpdates: true
          artifacts: build/dist/*.zip*
          bodyFile: "IMPORTANT.md"
          omitName: true
          tag: latest
      - name: Release new jar and war
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: build/dist/*.jar*,build/dist-war/*.war*
          omitBodyDuringUpdate: true
          omitName: true
          tag: latest
      - name: Update the 'latest' tag
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        run: |
          git push origin :refs/tags/latest || true
          git tag -m latest -fa latest || true
          git push origin main --tags
      - name: Generate all maven artifacts
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        shell: bash
        run: |
          python ./checker.py maven-artifacts
          python ./checker.py maven-sign
      - name: Release new maven packages to Maven Central and GitHub
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        shell: bash
        run: |
          python ./checker.py maven-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAVEN_USER_TOKEN: ${{ secrets.MAVEN_USER_TOKEN }}
      - name: Set up Node
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Install Node dependencies
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        run: npm install
      - name: Release new npm package to npmjs.com
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        shell: bash
        run: |
          python ./checker.py npm-release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      - name: Set up Node
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://npm.pkg.github.com'
      - name: Release new npm package to GitHub Packages
        if: ${{ env.IS_MAIN_RELEASE_BUILDER == 'true' }}
        shell: bash
        run: |
          python ./checker.py npm-github-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify-release-assets:
    name: Verify release assets
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Verify release assets and release state (not Draft/Pre-release)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXPECTED_ASSETS: |
            vnu.jar
            vnu.war
            vnu.linux.zip
            vnu.osx.zip
            vnu.windows.zip
        run: |
          set -euxo pipefail
          echo 'Fetching release metadata for tag “latest”…'
          release_json=$(gh api repos/${{ github.repository }}/releases/tags/latest)
          asset_names=$(echo "$release_json" | jq -r '.assets[].name')
          echo "Assets found in release:"
          echo "$asset_names"
          missing=0
          for expected in $EXPECTED_ASSETS; do
            if ! echo "$asset_names" | grep -qx "$expected"; then
              echo "::error::Missing expected asset: $expected"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "::error::One or more expected release assets are missing!"
            exit 1
          fi
          echo "✅ All expected release assets are present."
          echo "Verifying that release assets are downloadable..."
          for asset_url in $(echo "$release_json" | jq -r '.assets[].browser_download_url'); do
            if ! curl -fL --head --silent --max-time 20 "$asset_url" >/dev/null; then
              echo "::error::Asset not downloadable: $asset_url"
              exit 1
            fi
          done
          echo "✅ All release assets are downloadable."
          if [ "$(echo "$release_json" | jq -r '.draft')" = "true" ]; then
            echo "::error::Release is still in the Draft state!"
            exit 1
          fi
          if [ "$(echo "$release_json" | jq -r '.prerelease')" = "true" ]; then
            echo "::error::Release is marked as a Pre-release!"
            exit 1
          fi
          echo "✅ Release is not in the Draft or Pre-release state."

  ant-build:
    name: Ant build ${{ matrix.target }}
    needs: prep
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [
          build,
          jar,
          war,
          cssvalidator-build,
          cssvalidator-artifacts,
          galimatias-build,
          galimatias-artifacts,
          htmlparser-build,
          htmlparser-artifacts,
          jing-build,
          jing-artifacts,
          langdetect-build,
          langdetect-artifacts,
          validator-artifacts,
          validator-build,
          validator-bundle,
          validator-compare-full-and-merged-split,
          validator-javadoc-jar,
          validator-sources-jar,
          validator-split-client,
          validator-split-core,
          validator-split-server,
        ]
    steps:
      - uses: actions/checkout@v5
      - name: Set up Java JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 25
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Run target ${{ matrix.target }}
        run: ant -f build/build.xml ${{ matrix.target }}

  ant-clean:
    name: Ant clean
    needs: prep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Java JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 25
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Prepare experiment
        run: |
          tar -cf /tmp/archive.tar .
          mkdir -p _reference
          mkdir -p _experiment
          tar -C _reference -xf /tmp/archive.tar
          tar -C _experiment -xf /tmp/archive.tar
      - name: Run experiment
        run: |
          cd _experiment
          ant -f build/build.xml jar war
          ant -f build/build.xml distclean
      - name: Check differences
        run: diff -r _reference _experiment

  test-message-check:
    name: tests/message.json check
    needs: prep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Java JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 25
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Build vnu.jar
        run: python checker.py --version="$version" build
      - name: Rebuild tests/messages.json
        run: make VNUJAR=../build/dist/vnu.jar  -C tests/ messages.json
      - name: Check if there are changes to messages.json
        run: cd tests && git diff --exit-code messages.json
# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
